// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Event {
  id                   String   @id @default(uuid())
  title                String
  author               String
  location             String
  startAt              DateTime
  endAt                DateTime?
  seatLimit            Int?
  priceTotal           BigInt   // в копейках (BigInt для больших сумм)
  pricePerSeat         BigInt?  // в копейках (BigInt для больших сумм)
  image                String?
  category             String?
  description          String?
  activities           String?  // JSON array
  startApplicationsAt  DateTime? // ti10
  endApplicationsAt    DateTime? // ti20
  startContractsAt     DateTime? // ti30
  status               String   @default("draft") // draft | published
  producerName         String?
  producerCode         String?
  timezone             String?   @db.Text // IANA timezone identifier (например, "Europe/Moscow", "Asia/Sakhalin")
  createdAtClient      DateTime? // Время создания события на клиентском сайте (t0)
  publishedAt          DateTime? // Время публикации события
  
  // Новые поля для контрольных точек
  controlPlan          String   // JSON array: ["t0", "ti10", "ti20", "ti30", "ti40", "ti50", "t999"]
  currentControlPoint  String?  // текущая контрольная точка (t0 | ti10 | ti20 | ti30 | ti40 | ti50 | t999)
  isCancelled          Boolean  @default(false)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Связи
  statusHistory        EventStatusHistory[]
  payments             Payment[]
  
  @@index([publishedAt])
  @@index([timezone])
  @@map("events")
}

model EventStatusHistory {
  id         String   @id @default(uuid())
  eventId    String
  statusCode String   // t0 | ti10 | ti20 | ti30 | ti40 | ti50 | t999
  note       String?  // дополнительная информация
  createdAt  DateTime @default(now())
  
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@map("event_status_history")
  @@index([eventId])
}

model Payment {
  id             String   @id @default(uuid())
  eventId        String
  userId         String?  // может быть null для неавторизованных
  amount         BigInt   // в копейках (BigInt для больших сумм)
  currency       String   @default("RUB")
  status         String   @default("PENDING") // PENDING | SUCCESS | FAILED
  providerTxnId  String?  // TEST-UUID для тестовых платежей
  isTest         Boolean  @default(true)
  createdAt      DateTime @default(now())
  
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@map("payments")
  @@index([eventId])
  @@index([userId])
}

model ApiKey {
  id           String   @id @default(uuid())
  key          String   @unique // API ключ (например, "sk_live_...")
  producerCode String   // Внутренний код продюсера
  clientName   String?  // Название клиентского сайта (для удобства)
  clientUrl    String?  // URL клиентского сайта (опционально)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime? // Последнее использование ключа
  
  @@index([key])
  @@index([producerCode])
  @@map("api_keys")
}


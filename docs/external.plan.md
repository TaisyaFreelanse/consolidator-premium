# Реализация системы белых списков сайтов

## Обзор изменений

Полная замена системы API-ключей на систему белых списков внешних сайтов с возможностью модерации событий. Это упростит создание дополнительных демо-сайтов и централизует управление доступами.

## Архитектурные изменения

### 1. База данных

- **Новая таблица `WhitelistedSite`** для хранения разрешенных сайтов
- **Удаление таблицы `ApiKey`** и связанной логики
- **Добавление поля `requiresModeration`** в события для отслеживания статуса модерации

### 2. Демо-сайт

- **Удаление страницы получения API-ключа** [`pages/demo/api-register.vue`](pages/demo/api-register.vue)
- **Модификация настроек** [`pages/demo/settings.vue`](pages/demo/settings.vue) - добавление поля "Имя сайта"
- **Обновление навигации** [`components/DemoNavigation.vue`](components/DemoNavigation.vue) - удаление пункта регистрации

### 3. Платформа

- **Удаление регистрации продюсеров** из [`stores/auth.ts`](stores/auth.ts)
- **Новая страница управления белыми списками** для модератора
- **Модификация логики событий** - замена `producerName` на `siteAlias`

### 4. API

- **Замена авторизации по API-ключу** на проверку имени сайта в белом списке
- **Новые коды ошибок** для случаев отсутствия сайта в белом списке
- **Логика автоматической модерации** в зависимости от настроек сайта

## Детальный план реализации

### Этап 1: Подготовка базы данных

#### 1.1 Создание новой схемы ✅

- ✅ Создать миграцию Prisma для таблицы `WhitelistedSite`:
  ```prisma
  model WhitelistedSite {
    id                String   @id @default(cuid())
    siteName          String   @unique  // Имя сайта (URL или идентификатор)
    siteAlias         String   @unique  // Псевдоним для отображения
    requiresModeration Boolean @default(false) // Требует ли модерации
    isActive          Boolean  @default(true)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
  }
  ```


#### 1.2 Модификация схемы событий ✅

- ✅ Добавить поле `requiresModeration: Boolean` в модель `Event`
- ✅ Заменить `producerCode` на `siteAlias` в модели `Event`

#### 1.3 Миграция данных ✅

- ✅ Создать скрипт миграции существующих событий
- ✅ Удалить таблицу `ApiKey` после миграции

### Этап 2: Обновление демо-сайта

#### 2.1 Удаление API-ключей ✅

- ✅ **Удалить файл** [`pages/demo/api-register.vue`](pages/demo/api-register.vue)
- ✅ **Обновить** [`components/DemoNavigation.vue`](components/DemoNavigation.vue):
  - ✅ Удалить ссылку на "Настройки/Регистр"
  - ✅ Переименовать в "Настройки"

#### 2.2 Модификация настроек ✅

- ✅ **Обновить** [`pages/demo/settings.vue`](pages/demo/settings.vue):
  - ✅ Удалить секцию управления API-ключом
  - ✅ Добавить поле "Имя сайта" в настройки
  - ✅ Сохранять имя сайта в localStorage как `demo_site_name`

#### 2.3 Обновление загрузки событий ✅

- ✅ **Модифицировать** [`pages/demo/external-upload.vue`](pages/demo/external-upload.vue):
  - ✅ Убрать использование API-ключа из заголовков
  - ✅ Добавить `siteName` в тело запроса
  - ✅ Обновить обработку ошибок для новых кодов

### Этап 3: Обновление серверного API

#### 3.1 Удаление логики API-ключей ✅

- ✅ **Удалить файл** [`server/utils/apiKey.ts`](server/utils/apiKey.ts)
- ✅ **Удалить эндпоинт** [`server/api/external/register.post.ts`](server/api/external/register.post.ts)

#### 3.2 Создание утилит для белых списков ✅

- ✅ **Создать** `server/utils/whitelist.ts`:
  ```typescript
  export async function getSiteByName(siteName: string): Promise<WhitelistedSite | null>
  export async function isSiteWhitelisted(siteName: string): Promise<boolean>
  export async function createWhitelistedSite(data: CreateSiteData): Promise<WhitelistedSite>
  ```


#### 3.3 Обновление внешних API эндпоинтов ✅

- ✅ **Модифицировать** [`server/api/external/events/index.post.ts`](server/api/external/events/index.post.ts):
  - ✅ Заменить проверку API-ключа на проверку `siteName` в белом списке
  - ✅ Добавить логику установки `requiresModeration` на основе настроек сайта
  - ✅ Обновить коды ошибок

- ✅ **Обновить остальные внешние эндпоинты**:
  - ✅ [`server/api/external/events/[id].get.ts`](server/api/external/events/[id].get.ts)
  - ✅ [`server/api/external/events/[id]/monitoring.get.ts`](server/api/external/events/[id]/monitoring.get.ts)

### Этап 4: Управление белыми списками на платформе

#### 4.1 Создание страницы управления ✅

- ✅ **Создать** `pages/admin/whitelist.vue`:
  - ✅ Таблица всех сайтов в белом списке
  - ✅ Форма добавления нового сайта
  - ✅ Возможность редактирования псевдонима и флага модерации
  - ✅ Деактивация сайтов

#### 4.2 API для управления белыми списками ✅

- ✅ **Создать** `server/api/admin/whitelist/index.get.ts` - получение списка
- ✅ **Создать** `server/api/admin/whitelist/index.post.ts` - добавление сайта
- ✅ **Создать** `server/api/admin/whitelist/[id].patch.ts` - обновление сайта
- ✅ **Создать** `server/api/admin/whitelist/[id].delete.ts` - удаление сайта

#### 4.3 Интеграция в навигацию ✅

- ✅ **Обновить** [`components/Header.vue`](components/Header.vue):
  - ✅ Добавить пункт "Белые списки" для модераторов
  - ✅ Обновить проверки ролей

### Этап 5: Система модерации событий

#### 5.1 Логика модерации ✅

- ✅ **Модифицировать** логику создания событий:
  - ✅ События от сайтов с `requiresModeration: true` создаются со статусом `draft`
  - ✅ События от сайтов с `requiresModeration: false` сразу получают статус `published`
  - ✅ Обновлен внутренний API (`server/api/events/index.post.ts`) для поддержки модерации
  - ✅ Обновлен API публикации (`server/api/events/[id]/publish.patch.ts`) с проверками времени
  - ✅ Создан API отклонения (`server/api/events/[id]/reject.patch.ts`) для модераторов

#### 5.2 Интерфейс модерации ✅

- ✅ **Создать** `pages/admin/moderation.vue`:
  - ✅ Список событий, ожидающих модерации
  - ✅ Возможность одобрить/отклонить событие
  - ✅ Фильтрация по сайтам и датам
  - ✅ Создан API `server/api/admin/moderation/index.get.ts` для получения событий
  - ✅ Добавлен пункт "Модерация" в административное меню
  - ✅ Статистика и индикаторы срочности (время до ti20)
  - ✅ Детальный просмотр информации о событии

#### 5.3 Ограничения по времени ✅

- ✅ **Добавить проверку** в логику модерации:
  - ✅ После наступления Ti20 модератор не может изменить статус события
  - ✅ События остаются в статусе `draft` если не промодерированы вовремя
  - ✅ Создана утилита `server/utils/moderationTimeRestrictions.ts` для централизованных проверок
  - ✅ Создан middleware `server/utils/moderationMiddleware.ts` для автоматических проверок
  - ✅ Обновлены API эндпоинты публикации и отклонения с улучшенными проверками
  - ✅ Создана система автоматической очистки просроченных событий
  - ✅ Добавлены API для статистики и ручной очистки модерации

### Этап 6: Обновление существующей логики

#### 6.1 Замена producerName на siteAlias ✅

- ✅ **Обновить** [`pages/create-event.vue`](pages/create-event.vue):
  - ✅ Заменить поля продюсера на поля сайта (`eventSiteAlias`, `eventRequiresModeration`)
  - ✅ Обновить логику доступа - убрать концепцию продюсеров
  - ✅ Обновить валидацию и отображение
  - ✅ Заменить проверки прав на универсальные для авторизованных пользователей
  - ✅ Обновить UI - показывать источник события (платформа/внешний сайт)
  - ✅ Добавить индикатор модерации для внешних событий

#### 6.2 Обновление мониторинга ✅

- ✅ **Модифицировать** [`pages/monitoring.vue`](pages/monitoring.vue):
  - ✅ Убрать упоминания продюсеров из сообщений об ошибках
  - ✅ Добавить отображение псевдонима сайта в селекторе событий
  - ✅ Обновить тексты для универсальной терминологии
- ✅ **Обновить** [`components/EventStatus.vue`](components/EventStatus.vue):
  - ✅ Добавить отображение псевдонима сайта в мета-информации события
  - ✅ Показывать источник события (внешний сайт) рядом с автором

#### 6.3 Миграция пользовательских ролей ✅

- ✅ **Обновить** [`stores/auth.ts`](stores/auth.ts):
  - ✅ Удалить предустановленных продюсеров (`PRESET_PRODUCERS`)
  - ✅ Оставить только модератора и заявителей
  - ✅ Обновить проверки ролей (`isProducer` → `isApplicant`)
  - ✅ Добавить автоматическую миграцию для удаления старых продюсеров
- ✅ **Обновить** [`types/index.ts`](types/index.ts):
  - ✅ Убрать роль 'producer' из `UserRole`
- ✅ **Обновить использование** в компонентах:
  - ✅ [`stores/events.ts`](stores/events.ts) - убрать логику продюсеров
  - ✅ [`pages/catalog.vue`](pages/catalog.vue) - заменить `isProducer` на `isLoggedIn`
  - ✅ [`pages/create-event.vue`](pages/create-event.vue) - исправить ссылки на роли

### Этап 7: Документация и тестирование

#### 7.1 Обновление документации API ✅

- ✅ **Модифицировать** документацию в [`pages/demo/settings.vue`](pages/demo/settings.vue):
  - ✅ Удалить разделы про API-ключи (уже было выполнено ранее)
  - ✅ Добавить информацию о системе белых списков
  - ✅ Обновить примеры запросов с новыми полями (`requiresModeration`, `siteAlias`, `publishedAt`)
  - ✅ Добавить новые коды ошибок (409 Conflict)
  - ✅ Обновить примеры ответов мониторинга с `personalCalculations`
  - ✅ Добавить важные замечания о новой системе белых списков
  - ✅ Уточнить информацию об авторизации (отсутствие API-ключей)

#### 7.2 Создание тестовых данных ✅

- ✅ **Создать** seed-скрипт для белых списков (`scripts/seed-whitelist.ts`):
  - ✅ Добавить 6 тестовых сайтов с различными настройками модерации
  - ✅ Настроить различные сценарии модерации (с/без модерации, активные/неактивные)
  - ✅ Создать 3 демонстрационных события для тестирования
  - ✅ Добавить проверки дублирования и идемпотентность
  - ✅ Создать подробную документацию (`scripts/README-seed.md`)
  - ✅ Создать скрипт очистки тестовых данных (`scripts/cleanup-seed.ts`)
  - ✅ Добавить npm-скрипты для удобного запуска (`seed:whitelist`, `cleanup:seed`)

## Коды ошибок

### Новые коды ошибок для API

- **403001**: Сайт не найден в белом списке
- **403002**: Сайт деактивирован
- **403003**: Событие ожидает модерации
- **400001**: Не указано имя сайта в запросе

## Миграционная стратегия

### Обратная совместимость

- Существующие события сохраняют работоспособность
- API-ключи будут работать в переходный период (опционально)
- Постепенная миграция демо-сайтов

### План развертывания

1. **Фаза 1**: Создание новых таблиц и API (параллельно с существующими)
2. **Фаза 2**: Обновление демо-сайта для использования новой системы
3. **Фаза 3**: Миграция существующих данных
4. **Фаза 4**: Удаление старой системы API-ключей

## Преимущества новой системы

- **Упрощение**: Нет необходимости в регистрации и управлении API-ключами
- **Централизация**: Все управление доступами происходит на платформе
- **Гибкость**: Легко добавлять новые демо-сайты
- **Контроль**: Возможность модерации событий от определенных сайтов
- **Безопасность**: Отсутствие секретных ключей в клиентском коде
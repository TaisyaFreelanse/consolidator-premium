# План реализации: Этап 3 и Этап 4

## Этап 3: Документация API ✅ ЗАВЕРШЕН

### Задачи:
- [x] Подготовить полную документацию по внешнему API
- [x] Описать все эндпоинты для внешних запросов
- [x] Указать параметры запросов и форматы ответов
- [x] Добавить примеры использования API
- [x] Разместить документацию на странице "Настройки/регистр"

---

## Этап 4: Мониторинг и отчетность

### 4.1. Запрос данных мониторинга

**Требования:**
- Запрос данных мониторинга с платформы после контрольной точки Ти20
- Триггер: только по ручному нажатию на кнопку
- Контроль наступления Ти20 перед запросом (если не наступила — показать предупреждение)

**Обоснование решения (почему API-запрос, а не виджет):**
- **Безопасность:** Виджет — публичный компонент, в нем нельзя безопасно хранить API-ключ. API-запрос позволяет использовать авторизацию через API-ключ, хранящийся на демо-сайте (не в публичном коде).
- **Контроль доступа:** Нужна авторизация продюсера через API-ключ для доступа к его данным. Виджет не может безопасно хранить и использовать API-ключ продюсера.
- **Конфиденциальность данных:** Данные мониторинга содержат персональную информацию и данные о платежах. Виджет публичен и не подходит для передачи таких конфиденциальных данных.
- **Гибкость:** API-запрос позволяет контролировать момент запроса (только по кнопке), формат данных и обработку ошибок.
- **Согласованность:** Демо-сайт уже использует API-запросы для загрузки событий, логично использовать тот же подход для мониторинга.

**Задачи:**
- [x] Добавить кнопку запроса мониторинга на странице "Отчет платформы" (`/demo/platform-report`)
- [x] Добавить кнопку "Отчет платформы" в верхнее меню (DemoNavigation.vue), справа от кнопки "Загрузить на платформу" (уже было сделано ранее)
- [x] Реализовать проверку наступления Ти20 перед запросом
- [x] Использовать существующий API платформы для получения данных мониторинга (или создать эндпоинт на платформе, если его нет)
- [x] Реализовать запрос с демо-сайта к API платформы для получения данных мониторинга
- [x] Обработать ответ от платформы и отобразить данные на демо-сайте

**Данные по каждому заявителю:**
- [x] Признак вхождения в лимит (или причина невхождения)
- [x] Список всех платежей заявителя (реквизиты от ЮKassa)
- [x] Расчет возвращаемой суммы

---

### 4.2. Визуализация на платформе

**Требования:**
- Отобразить числа, участвующих в расчете возвращаемой суммы (для прозрачности)
- Добавить два новых поля справа от "Профицит" для прозрачности расчетов
- Заменить секретный код на логин в таблице мониторинга только для авторизованного пользователя (для остальных заявителей показывать секретный код)

**Базовые числа для визуализации (найдены в `components/EventStatus.vue`):**
1. **СОБРАНО** (`effectiveCollected`) — фактически собранная сумма с учетом лимита мест
2. **ТРЕБУЕТСЯ** (`event.priceTotal`) — требуемая сумма для проведения мероприятия
3. **ПРОФИЦИТ/НЕДОБОР** (`moneyStatus.amount`) — разница между собранным и требуемым (положительная = профицит, отрицательная = недобор)

**Дополнительные поля для прозрачности (справа от "Профицит"):**
4. **"Возврат сверхлимитчикам"** — сумма, которая будет возвращена участникам, не вошедшим в лимит мест
   - Полное название: "Возврат сверхлимитчикам"
   - Сокращенное название (если не влезает по ширине): "Возврат свехлим."
   - Логика: сверхлимитчикам (тем, кто не вошел в лимит) надо вернуть все их платежи
   - Расчет: сумма всех платежей от заявителей, которые не вошли в топ-N по сумме платежей (где N = лимит мест)
   - Примечание: название временное, клиент придумает лучшее позже
5. **"Профицит к распределению"** — сумма, которая остается после возврата сверхлимитчикам и будет распределяться между участниками, вошедшими в лимит
   - Расчет: `ПРОФИЦИТ - Возврат сверхлимитчикам`
   - Это критически важно для прозрачности — сейчас нигде не видно, сколько остается для распределения

**Текущее состояние:**
- Базовые числа уже отображаются в компоненте `EventStatus.vue` в разделе "Участники и средства" (строки 415-434)
- Необходимо добавить визуализацию всех чисел в таблице мониторинга и в PDF-отчетах
- **Проблема:** После возврата сверхлимитчикам не видно, сколько остается для распределения — это напрягает клиентов

**Задачи:**
- [x] Определены базовые три числа для визуализации
- [x] Определены дополнительные два поля (Возврат сверхлимитчикам, Профицит к распределению)
- [x] Реализовать расчет "Возврат сверхлимитчикам" (сумма всех платежей от заявителей вне лимита)
- [x] Реализовать расчет "Профицит к распределению" (ПРОФИЦИТ - Возврат сверхлимитчикам)
- [x] Добавить отображение всех пяти чисел в компоненте `EventStatus.vue` (справа от "Профицит")
- [x] Добавить отображение всех чисел в таблице мониторинга (`components/MonitoringTable.vue`)
- [ ] Добавить отображение всех чисел в PDF-отчетах (для каждого заявителя) - будет в этапе 4.3
- [x] Реализовать замену секретного кода на логин только для авторизованного пользователя (в таблице мониторинга)
- [x] Для остальных заявителей показывать секретный код (не заменять на логин)

**Примечание:** Третье число (про "две левых иконки") — несущественно, можно сделать потом.

---

### 4.3. Генерация PDF-отчетов

**Требования:**
- Отдельный PDF-файл на каждого заявителя
- Содержимое PDF:
  - Информация с экрана "Мониторинг"
  - Таблица платежей по заявителю
  - Все данные, позволяющие разобраться, к чему/кому относится файл
- Выгрузка в виде ZIP-архива
- Структурированные имена файлов (использовать логин заявителя, секретный код НЕ использовать в имени файла)

**Структура имен файлов (утверждена клиентом):**
- **ZIP-архив:** `Cons_ДДММГГГГ_ЧЧММ.zip`
  - Пример: `Cons_15112025_1430.zip` (15 ноября 2025, 14:30)
- **PDF-файлы внутри архива:** `Cons_ДДММГГГГ_ЧЧММ_Логин.pdf`
  - Пример: `Cons_15112025_1430_user123.pdf`
  - Логин берется из данных заявителя (на платформе все заявители авторизованы, логин всегда доступен)

**Задачи:**
- [x] Выбрать библиотеку для генерации PDF (jsPDF, pdfkit, puppeteer)
- [x] Выбрать библиотеку для создания ZIP-архивов (JSZip)
- [x] Создать шаблон PDF с информацией мониторинга
- [x] Добавить таблицу платежей в PDF
- [x] Реализовать генерацию отдельного PDF для каждого заявителя
- [x] Реализовать формирование ZIP-архива с правильной структурой имен
- [x] Реализовать скачивание ZIP-архива (браузер предложит выбрать папку для сохранения)

**Технические детали:**
- Формат даты/времени: ДДММГГГГ_ЧЧММ (например, 15112025_1430)
- Логин для имени файла: использовать логин заявителя (на платформе все заявители авторизованы, логин всегда доступен)
- В каждом PDF содержится вся необходимая информация для идентификации заявителя и события

---

### 4.4. Страница "Настройки/регистр"

**Требования:**
- Переименовать страницу "API-ключ" в "Настройки/регистр"
- Разместить документацию по API
- Настройка пути сохранения PDF не требуется (ZIP-архив скачивается через браузер)

**Задачи:**
- [x] Переименовать страницу `/demo/api-register` → `/demo/settings` (или обновить заголовок)
- [x] Обновить навигацию (DemoNavigation.vue)
- [x] Добавить раздел управления API-ключом
- [x] Добавить раздел с документацией API
- [x] Обновить все ссылки на старую страницу

---

---

## Порядок реализации:

1. **Этап 3** (документация API) — можно выполнить параллельно
2. **Этап 4.4** (страница настроек) — базовая инфраструктура
3. **Этап 4.1** (запрос мониторинга) — основная функциональность
4. **Этап 4.2** (визуализация) — отображение определенных выше чисел (СОБРАНО, ТРЕБУЕТСЯ, ПРОФИЦИТ/НЕДОБОР, Возврат сверхлимитчикам, Профицит к распределению)
5. **Этап 4.3** (PDF-генерация) — финальная часть

---

## Технические детали:

### API для мониторинга:
- **На платформе:** Эндпоинт `GET /api/events/:id/monitoring` (или создать, если отсутствует)
- **С демо-сайта:** Запрос к API платформы через внешний API (с использованием API-ключа)
- Условие: доступен только после Ти20
- Ответ: список заявителей с данными о платежах и статусе
- **Примечание:** API-эндпоинт создается/используется на платформе, демо-сайт только делает запрос к нему

### Генерация PDF:
- Библиотека: TBD (jsPDF или puppeteer)
- Библиотека для ZIP: JSZip
- Формат: A4, портретная ориентация
- Содержимое: данные мониторинга + таблица платежей
- Выгрузка: ZIP-архив с именем `Cons_ДДММГГГГ_ЧЧММ.zip`
- Файлы в архиве: `Cons_ДДММГГГГ_ЧЧММ_Логин.pdf` (по одному на каждого заявителя)

### Хранение настроек:
- Путь сохранения PDF: localStorage или настройки пользователя
- API-ключ: уже реализовано в localStorage

---

## Статус: ✅ ФИНАЛЬНОЕ ТЗ СОГЛАСОВАНО

**Дата согласования:** [текущая дата]  
**Статус:** Все вопросы закрыты, техническое задание полностью согласовано с клиентом.

### Согласованные требования:

- [x] Получен список базовых трех чисел для визуализации (СОБРАНО, ТРЕБУЕТСЯ, ПРОФИЦИТ/НЕДОБОР)
- [x] Получены уточнения по дополнительным полям (Возврат сверхлимитчикам, Профицит к распределению)
- [x] Уточнена структура имен файлов (`Cons_ДДММГГГГ_ЧЧММ.zip` и `Cons_ДДММГГГГ_ЧЧММ_Логин.pdf`)
- [x] Выбран вариант выгрузки PDF (ZIP-архив)
- [x] Определено место размещения кнопки запроса мониторинга (страница "Отчет платформы")
- [x] Уточнено название поля "Возврат сверхлимитчикам" (полное: "Возврат сверхлимитчикам", сокращенное: "Возврат свехлим.")
- [x] Уточнена логика замены секретного кода на логин (только для авторизованного пользователя)
- [x] Уточнена логика имен файлов (на платформе все заявители авторизованы, логин всегда доступен)
- [x] Согласовано обоснование использования API-запроса вместо виджета

**✅ План готов к реализации. Можно приступать к разработке.**


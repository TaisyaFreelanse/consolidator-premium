# Миграция к системе белых списков

## Обзор

Этот скрипт выполняет миграцию данных от системы API-ключей к системе белых списков сайтов.

## Что делает миграция

1. **Анализирует существующие события** - находит все уникальные `producerCode`
2. **Создает записи в WhitelistedSite** - для каждого уникального продюсера
3. **Обновляет события** - заменяет `producerCode` на `siteAlias`
4. **Устанавливает флаги** - `requiresModeration: false` для существующих данных

## Порядок выполнения

### 1. Применить миграцию базы данных
```bash
npx prisma migrate dev
```

### 2. Запустить скрипт миграции данных
```bash
npx tsx scripts/migrate-to-whitelist.ts
```

### 3. Применить миграцию удаления API ключей
```bash
npx prisma migrate dev
```

## Безопасность

- ✅ Скрипт проверяет существующие записи перед созданием
- ✅ Не удаляет существующие данные
- ✅ Логирует все операции
- ✅ Обрабатывает ошибки без остановки процесса

## Откат

Если нужно откатить изменения:

1. Восстановить таблицу `api_keys` из бэкапа
2. Удалить поля `siteAlias` и `requiresModeration` из событий
3. Удалить таблицу `whitelisted_sites`

## Тестирование

Перед запуском в продакшене рекомендуется:

1. Создать бэкап базы данных
2. Протестировать на копии данных
3. Проверить работу API после миграции
